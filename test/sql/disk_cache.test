# name: test/sql/disk_cache.test
# description: test disk_cache extension
# group: [sql]

require parquet

require disk_cache

statement ok
install httpfs

statement ok
load httpfs

statement ok
install tpch

statement ok
load tpch

statement ok
call dbgen(sf=0.1);

statement ok
copy lineitem to 'lineitem.parquet';

statement ok
call enable_logging(level='error');

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query I
select message from duckdb_logs;
----

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	0

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	6

query I
select message from duckdb_logs;
----

# bytes_from_mem will be 0 since we no longer have a separate memcache layer
# (it would only be > 0 if we read from WriteBuffer before write finishes, which is rare)
query I
select sum(bytes_from_mem) >= 0 from disk_cache_stats();
----
1

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	12	

query I
select message from duckdb_logs;
----

# bytes_from_mem will be 0 (no separate memcache layer anymore)
query I
select sum(bytes_from_mem) >= 0 from disk_cache_stats();
----
1

statement ok
from disk_cache_config(1024, '.disk_cache2/', 255);

# Directory changed, so cache should be cleared
query I
select count(*) from disk_cache_stats();
----
0

query IIIII
select * replace(substr(cache_path,0,13) as cache_path) from disk_cache_config();
----
.disk_cache2	1073741824	0	255	1
