# name: test/sql/blobcache.test
# description: test blobcache extension
# group: [sql]

require blobcache

require parquet

statement ok
install tpch

statement ok
load tpch

statement ok
call dbgen(sf=0.3);

statement ok
copy lineitem to 'lineitem.parquet';

statement ok
select max(l_comment) from read_parquet('debug://lineitem.parquet');

query III
select cache_type, count(*), sum(usage_count) from blobcache_stats() group by all order by all;
----
large	16	0
small	16	0

statement ok
select max(l_comment) from read_parquet('debug://lineitem.parquet');

query III
select cache_type, count(*), sum(usage_count) from blobcache_stats() group by all order by all;
----
large	16	16
small	16	16	

statement ok
set enable_external_file_cache = false;

statement ok
select max(l_comment) from read_parquet('debug://lineitem.parquet');

query III
select cache_type, count(*), sum(usage_count) from blobcache_stats() group by all order by all;
----
large	16	32
small	16	33

statement ok
from blobcache_config('.blobcache', 1);

query I
select count(*) from blobcache_stats() group by all;
----
0

statement ok
select max(l_comment) from read_parquet('debug://lineitem.parquet');

query III
select cache_type, count(*), sum(usage_count) from blobcache_stats() group by all order by all;
----
large	1	0
small	16	1

statement ok
select max(l_comment) from read_parquet('debug://lineitem.parquet');

query III
select cache_type, count(*), sum(usage_count) from blobcache_stats() group by all order by all;
----
large	1	1
small	16	18

query IIIII
from blobcache_config()
----
.blobcache/	1048576	28067	1	1

query I
select sum("end" - "start") from blobcache_stats();
----
28067

query IIIII
from blobcache_config('.blobcache/', 1024, 255);
----
.blobcache/	1073741824	0	255	1
